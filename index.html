<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Marvel Cinematic Universe</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Orbitron:wght@500;900&display=swap');

        body { margin: 0; overflow: hidden; background: radial-gradient(circle at center, #050505 0%, #000 90%); font-family: 'Orbitron', sans-serif; }
        
        #ui { position: absolute; top: 10%; width: 100%; text-align: center; color: #fff; pointer-events: none; z-index: 10; }
        
        /* METALLIC TEXT STYLE */
        h1 {
            font-family: 'Cinzel', serif; font-size: 3rem; margin: 0; letter-spacing: 8px; font-weight: 700; text-transform: uppercase;
            background: linear-gradient(to bottom, #cfc7f8 0%, #ffffff 50%, #6c757d 51%, #a9a9a9 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0px 2px 0px rgba(0,0,0,0.5)); text-shadow: 0px 0px 20px rgba(255, 255, 255, 0.3);
        }

        #hero-name { font-size: 1.2rem; color: #49a3d3; margin-top: 15px; letter-spacing: 4px; font-weight: 500; text-shadow: 0 0 10px currentColor; transition: color 0.3s ease; }
        
        #video-container { position: absolute; bottom: 20px; right: 20px; width: 240px; height: 160px; border: 2px solid rgba(255, 255, 255, 0.2); z-index: 20; background-color: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.8; }
        #output_canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; transform: scaleX(-1); }

        /* --- INFO BUTTON & MODAL --- */
        #info-btn {
            position: absolute; bottom: 30px; left: 30px; width: 50px; height: 50px;
            border-radius: 50%; background: rgba(5, 10, 20, 0.8); 
            color: #00d9ff; font-family: 'Cinzel', serif; font-size: 24px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            z-index: 50; box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
            transition: all 0.3s ease;
        }
        #info-btn::before {
            content: ''; position: absolute; top: -6px; left: -6px; right: -6px; bottom: -6px;
            border-radius: 50%; border: 1.5px solid rgba(0, 217, 255, 0.6);
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.8), inset 0 0 10px rgba(0, 217, 255, 0.6);
            animation: pulse-ring 2s infinite alternate ease-in-out;
        }
        #info-btn:hover { transform: scale(1.1); box-shadow: 0 0 25px rgba(0, 217, 255, 0.8); color: #fff; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 0.5; }
            100% { transform: scale(1.05); opacity: 1; }
        }

        #info-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 440px; background: rgba(5, 10, 20, 0.7); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px; padding: 40px; color: #fff; z-index: 60;
            opacity: 0; pointer-events: none; backdrop-filter: blur(15px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
        }
        #info-modal.active { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }

        #info-modal h2 {
            font-family: 'Cinzel', serif; color: #fff; text-align: center; margin-top: 0;
            letter-spacing: 5px; text-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 15px; font-size: 1.8rem;
        }
        #info-modal ul { list-style: none; padding: 0; margin: 0; font-family: 'Orbitron', sans-serif; }
        #info-modal li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 1rem; letter-spacing: 1.5px;
        }
        #info-modal li:last-child { border: none; }
        .gesture-name { color: #cfc7f8; }
        
        /* Hero Colors in the Modal */
        .color-thor { color: #88ccff; text-shadow: 0 0 8px rgba(136, 204, 255, 0.6); }
        .color-cap { color: #ffffff; text-shadow: 0 0 8px rgba(255, 255, 255, 0.6); }
        .color-tony { color: #00e5ff; text-shadow: 0 0 8px rgba(0, 229, 255, 0.6); }
        .color-thanos { color: #d400ff; text-shadow: 0 0 8px rgba(212, 0, 255, 0.6); }
        .color-loki { color: #00ff66; text-shadow: 0 0 8px rgba(0, 255, 102, 0.6); }
        .color-spidey { color: #ff3333; text-shadow: 0 0 10px rgba(255, 51, 51, 0.8); }
        .color-deadpool { color: #ff0000; text-shadow: 0 0 10px rgba(255, 0, 0, 0.8); }

        /* DOM PARTICLES AROUND MODAL */
        #particle-ring-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%; z-index: -1; pointer-events: none;
        }
        .ui-particle {
            position: absolute; border-radius: 50%; background: #fff;
            box-shadow: 0 0 8px #00d9ff, 0 0 15px #00d9ff;
        }
        .spin-layer-1 { animation: spin 25s linear infinite; position: absolute; inset: 0; }
        .spin-layer-2 { animation: spin-reverse 35s linear infinite; position: absolute; inset: 0; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes spin-reverse { 100% { transform: rotate(-360deg); } }

    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

<div id="ui">
    <h1>MARVEL CINEMATIC UNIVERSE</h1>
    <div id="hero-name">Initializing Systems...</div>
</div>

<div id="video-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="output_canvas"></canvas>
</div>

<div id="info-btn">i</div>

<div id="info-modal">
    <div id="particle-ring-container">
        <div class="spin-layer-1" id="layer1"></div>
        <div class="spin-layer-2" id="layer2"></div>
    </div>
    
    <h2>GESTURE PROTOCOL</h2>
    <ul>
        <li><span class="gesture-name">üñêÔ∏è Full Palm</span> <span class="color-thor">THOR</span></li>
        <li><span class="gesture-name">‚úä Closed Fist</span> <span class="color-cap">CAPTAIN AMERICA</span></li>
        <li><span class="gesture-name">‚úåÔ∏è Peace Sign</span> <span class="color-tony">IRON MAN</span></li>
        <li><span class="gesture-name">ü§ü Web Shooter</span> <span class="color-spidey">SPIDER-MAN</span></li>
        <li><span class="gesture-name">ü§è Pinch</span> <span class="color-thanos">THANOS</span></li>
        <li><span class="gesture-name">‚òùÔ∏è Single Finger</span> <span class="color-loki">LOKI</span></li>
        <li><span class="gesture-name">üñï Middle Finger</span> <span class="color-deadpool">DEADPOOL</span></li>
    </ul>
</div>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    // --- UI Logic (Particles & Toggle) ---
    const infoBtn = document.getElementById('info-btn');
    const infoModal = document.getElementById('info-modal');
    infoBtn.addEventListener('click', () => {
        infoModal.classList.toggle('active');
        infoBtn.innerText = infoModal.classList.contains('active') ? 'X' : 'i';
    });

    function createUIParticles(layerId, count, radiusBase) {
        const layer = document.getElementById(layerId);
        for(let i=0; i<count; i++) {
            const p = document.createElement('div');
            p.className = 'ui-particle';
            const angle = (i / count) * Math.PI * 2 + Math.random();
            const radius = radiusBase + (Math.random() * 30 - 15);
            const x = Math.cos(angle) * radius;
            const y = Math.sin(angle) * radius;
            p.style.left = `calc(50% + ${x}px)`;
            p.style.top = `calc(50% + ${y}px)`;
            const size = Math.random() * 2.5 + 1;
            p.style.width = `${size}px`; p.style.height = `${size}px`;
            p.style.opacity = Math.random() * 0.6 + 0.2;
            if (Math.random() > 0.5) p.style.boxShadow = `0 0 8px #d400ff, 0 0 15px #d400ff`;
            layer.appendChild(p);
        }
    }
    createUIParticles('layer1', 60, 270);
    createUIParticles('layer2', 45, 230);

    // --- THREE.JS LOGIC ---
    let currentTech = 'neutral';
    const videoElement = document.getElementById('video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const nameEl = document.getElementById('hero-name');

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 60;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
    composer.addPass(bloomPass);

    const COUNT = 14000; 
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(COUNT * 3);
    const colors = new Float32Array(COUNT * 3);
    const targetPositions = new Float32Array(COUNT * 3);
    const targetColors = new Float32Array(COUNT * 3);

    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

    const material = new THREE.PointsMaterial({ size: 0.4, vertexColors: true, blending: THREE.AdditiveBlending, transparent: true });
    const particles = new THREE.Points(geometry, material);
    scene.add(particles);

    function getBackground(color) {
        return {
            x: (Math.random() - 0.5) * 220,
            y: (Math.random() - 0.5) * 160,
            z: (Math.random() - 0.5) * 120,
            r: color[0] * 0.2, g: color[1] * 0.2, b: color[2] * 0.2
        };
    }

    // --- SPIDER-MAN REWRITE: SHARP ANGULAR LOGO ---
    function getSpiderman(i) {
        // Deep cosmic blue/red background
        if (i < COUNT * 0.4) return getBackground([0.1, 0.1, 0.8]);

        const t = (i - COUNT * 0.4) / (COUNT * 0.6);
        let x, y, z = (Math.random() - 0.5) * 2;
        
        // 1. Sharp Shield-Shaped Abdomen (15% of particles)
        if (t < 0.15) {
            let u = Math.random();
            let v = Math.random();
            y = -1 - u * 15; // Vertical length
            let width;
            if (u < 0.3) {
                // Top section: sharp widening
                width = 1.0 + (u / 0.3) * 3.5; 
            } else {
                // Bottom section: long sharp taper to a point
                width = 4.5 * (1 - (u - 0.3) / 0.7); 
            }
            x = (v - 0.5) * width * 2;
        } 
        // 2. Sharp Pointed Head (5% of particles)
        else if (t < 0.20) {
            let u = Math.random();
            let v = Math.random();
            y = 0 + u * 5; 
            let width;
            if (u < 0.5) {
               width = 1.0 + (u / 0.5) * 2.0; // Base widening
            } else {
               width = 3.0 * (1 - (u - 0.5) / 0.5); // Taper to mandibles
            }
            x = (v - 0.5) * width * 2;
        } 
        // 3. The 8 Angular Legs (80% of particles)
        else {
            const legNum = Math.floor((t - 0.20) / 0.10); // 0 to 7 (8 legs total)
            const isLeft = legNum % 2 === 0;
            const legPair = Math.floor(legNum / 2); // Pair 0, 1, 2, 3
            
            let p0, p1, p2; // Three anchors: Base, Sharp Elbow, Tip
            
            // Map exact coordinates from the sharp logo reference
            if (legPair === 0) { // Top legs (Up and out, bend straight up)
                p0 = [3, 1]; p1 = [10, 10]; p2 = [9, 24];
            } else if (legPair === 1) { // Upper-mid legs (Out, bend out/up)
                p0 = [3, -1]; p1 = [14, 2]; p2 = [20, 16];
            } else if (legPair === 2) { // Lower-mid legs (Out, bend out/down)
                p0 = [3, -3]; p1 = [15, -6]; p2 = [13, -24];
            } else { // Bottom legs (Down, bend down/in hugging the abdomen)
                p0 = [2.5, -5]; p1 = [8, -14]; p2 = [3, -28];
            }

            let u = Math.random();
            // Assign particles to line segments (40% to first thick segment, 60% to long thin segment)
            let isFirstSeg = u < 0.4;
            let segU = isFirstSeg ? (u / 0.4) : ((u - 0.4) / 0.6);

            // Calculate precise linear interpolation (Straight lines for sharp corners)
            if (isFirstSeg) {
                x = p0[0] + (p1[0] - p0[0]) * segU;
                y = p0[1] + (p1[1] - p0[1]) * segU;
            } else {
                x = p1[0] + (p2[0] - p1[0]) * segU;
                y = p1[1] + (p2[1] - p1[1]) * segU;
            }

            // Tapering thickness (Thick at base -> Thin at tips)
            let thickness = (1 - u) * 2.0; 
            x += (Math.random() - 0.5) * thickness;
            y += (Math.random() - 0.5) * thickness;
            
            if (isLeft) x = -x; // Mirror perfectly
        }
        
        // Scale and shift the final shape
        return { 
            x: x * 1.1, 
            y: (y + 2) * 1.1, 
            z: z, 
            r: 1.0, g: 0.05, b: 0.05 // Spidey Red
        };
    }

    function getDeadpool(i) {
        if (i < COUNT * 0.4) return getBackground([1.0, 0.1, 0.1]);
        const t = (i - COUNT * 0.4) / (COUNT * 0.6);
        if (t < 0.25) { return { x: (Math.random() - 0.5) * 8, y: (Math.random() - 0.5) * 70, z: (Math.random() - 0.5) * 5, r: 0.1, g: 0.1, b: 0.1 }; }
        else if (t < 0.45) { 
            const side = Math.random() > 0.5 ? 1 : -1;
            const a = 7; const b = 3.5;
            const fillFactor = Math.sqrt(Math.random()); 
            const angle = Math.random() * Math.PI * 2;
            let ex = a * fillFactor * Math.cos(angle); let ey = b * fillFactor * Math.sin(angle);
            const tilt = side * -0.35; 
            return { x: (side * 16) + (ex * Math.cos(tilt) - ey * Math.sin(tilt)), y: 4 + (ex * Math.sin(tilt) + ey * Math.cos(tilt)), z: 3, r: 0.8, g: 0.8, b: 0.8 };
        } else {
            const angle = Math.random() * Math.PI * 2;
            const radius = 28 + Math.random() * 12; 
            return { x: Math.cos(angle) * radius, y: Math.sin(angle) * radius, z: (Math.random() - 0.5) * 10, r: 0.9 + Math.random()*0.1, g: 0.0, b: 0.1 };
        }
    }

    function getLoki(i) {
        if (i < COUNT * 0.4) return getBackground([0, 1, 0.4]);
        const r = 18 + Math.random() * 4;
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos(2 * Math.random() - 1);
        return { x: r * Math.sin(phi) * Math.cos(theta), y: r * Math.sin(phi) * Math.sin(theta), z: r * Math.cos(phi), r: 0.0, g: 1.0, b: 0.4 };
    }

    function getThanos(i) {
        if (i < COUNT * 0.4) return getBackground([0.8, 0.2, 1]);
        const stones = [{c:[1,1,0],p:[0,0,0]}, {c:[0,0.2,1],p:[-6,6,0]}, {c:[1,0,0],p:[6,6,0]}, {c:[0.6,0,1],p:[-8,-4,0]}, {c:[1,0.5,0],p:[8,-4,0]}, {c:[0,1,0.2],p:[0,-10,0]}];
        const stone = stones[i % stones.length];
        const r = Math.random() * 4;
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos(2 * Math.random() - 1);
        return { x: stone.p[0] + r * Math.sin(phi) * Math.cos(theta), y: stone.p[1] + r * Math.sin(phi) * Math.sin(theta), z: stone.p[2] + r * Math.cos(phi), r: stone.c[0], g: stone.c[1], b: stone.c[2] };
    }

    function getThor(i) {
        if (i < COUNT * 0.4) return getBackground([0.4, 0.8, 1]);
        const t = (i - COUNT*0.4) / (COUNT*0.6);
        if (t < 0.6) return { x:(Math.random()-0.5)*28, y:(Math.random()-0.5)*16+12, z:(Math.random()-0.5)*14, r:0.7, g:0.7, b:0.8 };
        if (t < 0.9) return { x:(Math.random()-0.5)*2.5, y:(Math.random()*-35)+4, z:(Math.random()-0.5)*2.5, r:0.35, g:0.25, b:0.15 };
        const angle = Math.random()*Math.PI*2;
        return { x:Math.cos(angle)*25, y:Math.sin(angle)*25+8, z:(Math.random()-0.5)*15, r:0.4, g:0.8, b:1.0 };
    }

    function getCap(i) {
        if (i < COUNT * 0.4) return getBackground([0.2, 0.5, 1]);
        const t = (i - COUNT * 0.4) / (COUNT * 0.6);
        const angle = Math.random() * Math.PI * 2;
        const layer = Math.floor(t * 4);
        if (layer === 0) return { x: Math.cos(angle)*(40+Math.random()*2), y: Math.sin(angle)*(40+Math.random()*2), z: (Math.random()-0.5)*2, r: 1, g: 0, b: 0 };
        if (layer === 1) return { x: Math.cos(angle)*(32+Math.random()*2), y: Math.sin(angle)*(32+Math.random()*2), z: (Math.random()-0.5)*2, r: 1, g: 1, b: 1 };
        if (layer === 2) return { x: Math.cos(angle)*(24+Math.random()*2), y: Math.sin(angle)*(24+Math.random()*2), z: (Math.random()-0.5)*2, r: 1, g: 0, b: 0 };
        
        if (Math.random() > 0.4) {
            return { x: Math.cos(angle)*(Math.random()*18), y: Math.sin(angle)*(Math.random()*18), z: -0.5, r: 0, g: 0.2, b: 0.8 };
        } else {
            const rOut = 13; const rIn = 5; const totalSegments = 10;
            const k = Math.floor(Math.random() * totalSegments);
            const ak = (k / totalSegments) * Math.PI * 2 - (Math.PI / 2);
            const ak1 = ((k + 1) / totalSegments) * Math.PI * 2 - (Math.PI / 2);
            const pk = { x: ((k % 2 === 0) ? rOut : rIn) * Math.cos(ak), y: ((k % 2 === 0) ? rOut : rIn) * Math.sin(ak) };
            const pk1 = { x: (((k + 1) % 2 === 0) ? rOut : rIn) * Math.cos(ak1), y: (((k + 1) % 2 === 0) ? rOut : rIn) * Math.sin(ak1) };
            const r1 = Math.sqrt(Math.random()); const r2 = Math.random();
            return { x: (r1 * (1 - r2)) * pk.x + (r1 * r2) * pk1.x, y: (r1 * (1 - r2)) * pk.y + (r1 * r2) * pk1.y, z: 0.8, r: 1.0, g: 1.0, b: 1.0 };
        }
    }

    function getTony(i) {
        if (i < COUNT * 0.4) return getBackground([0, 0.8, 1]);
        const t = (i - COUNT*0.4) / (COUNT*0.6);
        let lay = t < 0.4 ? 0 : t < 0.6 ? 1 : t < 0.8 ? 2 : 3;
        const rads = [15, 22, 30, 38];
        const r = rads[lay];
        const side = Math.floor(Math.random() * 3);
        const a1 = (side * 120) * (Math.PI / 180);
        const a2 = ((side + 1) * 120) * (Math.PI / 180);
        const p1 = { x: Math.cos(a1)*r, y: Math.sin(a1)*r };
        const p2 = { x: Math.cos(a2)*r, y: Math.sin(a2)*r };
        const lerp = Math.random();
        const col = lay === 0 ? {r:0.8, g:0.95, b:1} : {r:0.2, g:0.6, b:1};
        return { x:p1.x + (p2.x-p1.x)*lerp, y:p1.y + (p2.y-p1.y)*lerp, z:0, r:col.r, g:col.g, b:col.b };
    }

    function updateState(tech) {
        if (currentTech === tech) return;
        currentTech = tech;
        nameEl.style.color = '#49a3d3'; 

        if (tech === 'thor') { nameEl.innerText = "THOR ‚Äî MJOLNIR"; bloomPass.strength = 3.0; }
        else if (tech === 'cap') { nameEl.innerText = "CAPTAIN AMERICA ‚Äî VIBRANIUM SHIELD"; bloomPass.strength = 2.0; }
        else if (tech === 'loki') { nameEl.innerText = "LOKI ‚Äî MAGIC"; bloomPass.strength = 2.5; }
        else if (tech === 'thanos') { nameEl.innerText = "THANOS ‚Äî INFINITY STONES"; bloomPass.strength = 4.0; }
        else if (tech === 'tony') { nameEl.innerText = "IRON MAN ‚Äî ARC-REACTOR CORE"; bloomPass.strength = 3.0; }
        else if (tech === 'deadpool') { nameEl.innerText = "DEADPOOL ‚Äî MARVEL JESUS"; nameEl.style.color = '#ff0000'; bloomPass.strength = 4.5; }
        else if (tech === 'spidey') { nameEl.innerText = "SPIDER-MAN ‚Äî WEB SHOOTERS"; nameEl.style.color = '#ff3333'; bloomPass.strength = 3.5; }
        else { nameEl.innerText = "AWAITING ACTIVATION..."; bloomPass.strength = 1.2; }

        for (let i = 0; i < COUNT; i++) {
            let p;
            if (tech === 'thor') p = getThor(i);
            else if (tech === 'cap') p = getCap(i);
            else if (tech === 'loki') p = getLoki(i);
            else if (tech === 'thanos') p = getThanos(i);
            else if (tech === 'tony') p = getTony(i);
            else if (tech === 'deadpool') p = getDeadpool(i);
            else if (tech === 'spidey') p = getSpiderman(i);
            else { p = { x:(Math.random()-0.5)*220, y:(Math.random()-0.5)*160, z:(Math.random()-0.5)*120, r:0.05, g:0.05, b:0.15 }; }
            
            targetPositions[i*3] = p.x; targetPositions[i*3+1] = p.y; targetPositions[i*3+2] = p.z;
            targetColors[i*3] = p.r; targetColors[i*3+1] = p.g; targetColors[i*3+2] = p.b;
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.8, minTrackingConfidence: 0.8 });
    
    hands.onResults((results) => {
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        let detected = 'neutral';
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            
            const isUp = (tip, pip) => lm[tip].y < (lm[pip].y - 0.03);
            const isDown = (tip, pip) => lm[tip].y > (lm[pip].y + 0.01);

            const indexUp = isUp(8, 6); const middleUp = isUp(12, 10); const ringUp = isUp(16, 14); const pinkyUp = isUp(20, 18);
            const indexDown = isDown(8, 6); const middleDown = isDown(12, 10); const ringDown = isDown(16, 14); const pinkyDown = isDown(20, 18);

            const handSize = Math.hypot(lm[0].x - lm[9].x, lm[0].y - lm[9].y);
            const pinchDist = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
            const isPinching = pinchDist < (handSize * 0.35); 
            const indexExtended = lm[8].y < lm[5].y; 

            // PRIORITY CHAIN
            if (middleUp && indexDown && ringDown) { detected = 'deadpool'; }
            else if (indexUp && pinkyUp && middleDown && ringDown && !isPinching) { detected = 'spidey'; }
            else if (indexUp && middleUp && ringDown && pinkyDown && !isPinching) { detected = 'tony'; }
            else if (indexUp && middleUp && ringUp && pinkyUp) { detected = 'thor'; }
            else if (indexUp && middleDown && ringDown && pinkyDown) { detected = 'loki'; }
            else if (isPinching && indexExtended) { detected = 'thanos'; }
            else if (indexDown && middleDown && ringDown && pinkyDown) { detected = 'cap'; }
        }
        
        updateState(detected);
    });

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 640, height: 480
    });
    cameraUtils.start();

    function animate() {
        requestAnimationFrame(animate);
        const time = Date.now();
        const pos = particles.geometry.attributes.position.array;
        const col = particles.geometry.attributes.color.array;

        for(let i=0; i<COUNT*3; i++) {
            pos[i] += (targetPositions[i] - pos[i]) * 0.12;
            col[i] += (targetColors[i] - col[i]) * 0.12;
        }
        particles.geometry.attributes.position.needsUpdate = true;
        particles.geometry.attributes.color.needsUpdate = true;

        // --- ANIMATIONS ---
        if (currentTech === 'thor') { 
            particles.rotation.y += 0.005; particles.rotation.x = 0; particles.rotation.z = 0; bloomPass.strength = 1.5 + (Math.random() > 0.98 ? 1.5 : 0);
        }
        else if (currentTech === 'cap') { particles.rotation.z += 0.015; }
        else if (currentTech === 'loki') { particles.rotation.y += 0.02; particles.position.y = Math.sin(time*0.002)*2; }
        else if (currentTech === 'thanos') { particles.rotation.y += 0.005; bloomPass.strength = 3.0 + Math.sin(time*0.005)*1.5; }
        else if (currentTech === 'tony') { particles.rotation.z += 0.01; bloomPass.strength = 2.0 + Math.sin(time*0.003)*0.5; }
        else if (currentTech === 'deadpool') { 
            particles.rotation.z += 0.05; bloomPass.strength = 4.5 + Math.sin(time * 0.01) * 2.0;
            particles.position.x = (Math.random()-0.5)*0.5; particles.position.y = (Math.random()-0.5)*0.5;
        }
        else if (currentTech === 'spidey') {
            particles.rotation.z = Math.sin(time * 0.001) * 0.05; 
            bloomPass.strength = 3.5 + Math.sin(time * 0.005) * 0.5;
            particles.position.set(0,0,0);
        }
        else { 
            particles.rotation.y += 0.001; bloomPass.strength = 1.0 + Math.sin(time * 0.001) * 0.2; particles.position.set(0,0,0);
        }

        composer.render();
    }
    animate();
</script>
</body>
</html>